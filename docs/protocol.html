<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Protocol - Experiment 13</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Experiment 13</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="e13-protocol"><a class="header" href="#e13-protocol">e13 Protocol</a></h1>
<p>In order for this concept to work, the services in question need to follow a particular protocol. As mentioned earlier, all messages sent between programs should be in a JSONL (JSON Lines) format. This means that each line in the file is a valid JSON object, and the file can be read line by line.</p>
<p>Much like HTTP though, simply using bodies of messages is not enough. We need to define a protocol that specifies both information that referers to the object being passed itself, and meta information that describes the message itself. This is similar to HTTP headers, but in this case we will use a JSON object to represent the message.</p>
<p>All types in the following document will be defined in
TypeScript. Quicktype can be used to generate types in other languages or in universal formats like JSON Schema. TypeScript is used here for its simplicity and readability, but the concepts can be easily translated to other languages.</p>
<p>All messages should have the following keys</p>
<ul>
<li>type</li>
<li>header</li>
<li>body</li>
</ul>
<p>Type and header are static types, they will always be the same shape, while body is dynamic and can change based on the message type.</p>
<h3 id="type"><a class="header" href="#type">Type</a></h3>
<p>Type is always a string, and it should be a unique identifier for the message type. This allows services to know how to handle the message.</p>
<h3 id="header"><a class="header" href="#header">Header</a></h3>
<pre><code class="language-typescript">Record&lt;string, string&gt;
</code></pre>
<p>The header contains metadata about the message. Headers are arbitrary key-value pairs, but there are some reserved keys that should always be present:</p>
<h4 id="id"><a class="header" href="#id">id</a></h4>
<p>The <code>id</code> is a unique identifier for the message. This allows services to track messages and ensure they are processed only once. It is also usefule for tracing and debugging.</p>
<pre><code class="language-ts">type RequestMessage = {
  type: string;
  header: {
    request: string; // Unique identifier for the request
    timestamp: string; // ISO 8601 timestamp of when the message was created
  };
  body: Record&lt;string, any&gt;; // Actual message content
};
</code></pre>
<pre><code class="language-json">{
  "type": "message_type",
  "header": {
    "request": "unique_id",
    "timestamp": "2023-10-01T12:00:00Z"
  },
  "body": {
    // actual message content
  }
}
</code></pre>
<h3 id="reserved-types"><a class="header" href="#reserved-types">Reserved types</a></h3>
<p>Typically the string used in the top level type key is used to identify what content will be in the body. Therefore protocol messages can be thought of as discriminated unions. The messages you send between your services are therefore defined by you, however there are some reserved types that are used by the system itself.</p>
<h4 id="log"><a class="header" href="#log">Log</a></h4>
<p>Messages with log are handled by e13-log service which can be inserted into the pipeline to handle logging. This is useful for debugging and monitoring purposes.</p>
<p><strong>Type:</strong></p>
<pre><code class="language-ts">type LogMessage {
  type: "log";
  header: {
    request: string;
    program: string; 
    context?: string;
    timestamp: string;
  };
  body: {
    level: "info" | "warn" | "error";
    message: string;
    context?: string;
  };
}
</code></pre>
<p><strong>Example:</strong></p>
<pre><code class="language-json">{
  "type": "log",
  "header": {
    "id": "log_123",
    "timestamp": "2023-10-01T12:00:00Z"
  },
  "body": {
    "level": "info",
    "message": "Service A started successfully.",
    "context": "Service A"
  }
}
</code></pre>
<h1 id="suggested-tooling"><a class="header" href="#suggested-tooling">Suggested Tooling</a></h1>
<ul>
<li><a href="https://quicktype.io/">Quicktype</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="hypotheses.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="hypotheses.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
